# 类型定义语法规则

本文档定义用于技术规范文档的类型定义伪代码语法。

---

## 语法规则

### 1. 类型定义

```yaml
RECORD Type_name:      # 记录/结构体（类似 class/struct）
ENUM Type_name:        # 枚举类型
INTERFACE Type_name:   # 接口定义
```

### 2. 字段定义

```yaml
field_name : Type                    # 必需字段
field_name : Type | None             # 可选字段（可为空）
field_name : Type | AnotherType      # 联合类型（二选一）
field_name : Type    -- 注释说明      # 行尾注释
```

### 3. 函数定义

```yaml
FUNCTION name(param1: Type, param2: Type) -> ReturnType
FUNCTION name() -> Void              # 无返回值
FUNCTION name(request: Request) -> AsyncIterator<StreamEvent>  # 异步迭代器返回
```

### 4. 属性定义（接口中）

```yaml
PROPERTY name : Type
```

### 5. 泛型

```yaml
List<T>              # T 的有序集合
Dict<K, V>           # 键值映射
AsyncIterator<T>     # 异步迭代器
```

### 6. 基本类型

```yaml
String      # 文本
Integer     # 整数
Float       # 小数
Boolean     # 真/假
Bytes       # 原始二进制数据
Dict        # 键值映射
List<T>     # 有序集合
Timestamp   # 时间戳
Void        # 无返回值
```

### 7. 类型组合

```yaml
T | None     # 可选类型
T | U        # 联合类型（任一）
```

### 8. 缩进规则

```yaml
RECORD Parent:
    field1 : Type
    nested_record : NestedType    # 使用缩进（4 空格或 2 空格）表示层级
```

### 9. 注释规范

```yaml
-- 行尾注释，说明字段用途
-- 多行注释也是用 --
-- 每行以 -- 开头
```

---

## 完整示例

### 记录类型

```yaml
RECORD Message:
    role          : Role                  -- 谁产生了此消息
    content       : List<ContentPart>     -- 消息主体（多模态）
    name          : String | None         -- 用于工具消息和开发者属性
    tool_call_id  : String | None         -- 将工具结果消息链接到其工具调用
```

### 枚举类型

```yaml
ENUM Role:
    SYSTEM       -- 高级指令，塑造模型行为
    USER         -- 人类输入
    ASSISTANT    -- 模型输出
    TOOL         -- 工具执行结果
    DEVELOPER    -- 应用程序的特权指令
```

### 接口类型

```yaml
INTERFACE ProviderAdapter:
    PROPERTY name : String             -- 例如，"openai"、"anthropic"

    FUNCTION complete(request: Request) -> Response
        -- 发送请求，阻塞直到模型完成

    FUNCTION stream(request: Request) -> AsyncIterator<StreamEvent>
        -- 发送请求，返回流式事件
```

### 带泛型的记录

```yaml
RECORD Usage:
    input_tokens        : Integer           -- 提示中的令牌
    output_tokens       : Integer           -- 模型生成的令牌
    total_tokens        : Integer           -- 输入 + 输出
    reasoning_tokens    : Integer | None    -- 思维链推理令牌
    cache_read_tokens   : Integer | None    -- 从缓存读取的令牌
```

---

## 现有参考规范

如果你不想使用这种自定义语法，可以直接参考以下现成标准：

| 规范 | 适用场景 | 示例 |
|------|----------|------|
| **TypeScript** | 最通用、最易读 | `interface Message { role: Role; }` |
| **Protocol Buffers** | 数据序列化 | `message Message { Role role = 1; }` |
| **OpenAPI 3.0** | REST API 文档 | YAML 风格的 schema 定义 |
| **Web IDL** | W3C 标准规范 | `interface Message { readonly attribute Role role; }` |

### TypeScript 示例（推荐）

```typescript
interface Message {
    role: Role;
    content: ContentPart[];
    name?: string;           // ? 表示可选
    tool_call_id?: string;
}

type Role = "system" | "user" | "assistant" | "tool" | "developer";
```

### Protocol Buffers 示例

```protobuf
message Message {
  Role role = 1;
  repeated ContentPart content = 2;
  optional string name = 3;
  optional string tool_call_id = 4;
}

enum Role {
  SYSTEM = 0;
  USER = 1;
  ASSISTANT = 2;
}
```

---

## 建议

1. **对于新项目**：直接使用 TypeScript 语法，最易读且广泛理解
2. **对于语言无关规范**：使用本文档的伪代码语法，但保持一致
3. **对于需要工具验证的场景**：使用 Protocol Buffers 或 OpenAPI

关键原则：**选定一种风格后，在整个文档中保持一致**。
